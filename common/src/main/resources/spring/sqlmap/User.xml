<?xml version="1.0" encoding="GBK" ?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="QTH_USER">
	<typeAlias alias="USER_POJO" type="com.xhm.longxin.qth.dal.dataobject.User" />
	<typeAlias alias="INTEREST_POJO"
		type="com.xhm.longxin.qth.dal.dataobject.UserInterest" />
	<resultMap id="USER_RESULT_MAP" class="USER_POJO">
		<result property="id" column="ID" jdbcType="BIGINT" javaType="long" />
		<result property="loginId" column="login_id" jdbcType="VARCHAR"
			javaType="String" />
		<result property="name" column="name" jdbcType="VARCHAR"
			javaType="String" />
		<result property="gender" column="gender" jdbcType="VARCHAR"
			javaType="String" />
		<result property="email" column="email" jdbcType="VARCHAR"
			javaType="String" />
		<result property="phoneArea" column="phone_area" jdbcType="VARCHAR"
			javaType="String" />
		<result property="phoneNumber" column="phone_number" jdbcType="VARCHAR"
			javaType="String" />
		<result property="company" column="company" jdbcType="VARCHAR"
			javaType="String" />
		<result property="companyAddress" column="company_address"
			jdbcType="VARCHAR" javaType="String" />
		<result property="role" column="role" jdbcType="VARCHAR"
			javaType="String" />
		<result property="idCardNum" column="id_card_num" jdbcType="VARCHAR"
			javaType="String" />
		<result property="busiLicense" column="busi_license" jdbcType="VARCHAR"
			javaType="String" />
		<result property="buyInterests" column="login_id"
			select="QTH_USER.SELECT_BUY_INST" />
		<result property="saleInterests" column="login_id"
			select="QTH_USER.SELECT_SALE_INST" />
		<result property="userLevel" column="user_level" jdbcType="VARCHAR"
			javaType="String" />
		<result property="status" column="status" jdbcType="VARCHAR"
			javaType="String" />
	</resultMap>

	<resultMap id="USER_INTEREST_RESULT_MAP" class="INTEREST_POJO">
		<result property="id" column="ID" jdbcType="BIGINT" javaType="long" />
		<result property="loginId" column="login_id" jdbcType="VARCHAR"
			javaType="String" />
		<result property="value" column="value" jdbcType="VARCHAR"
			javaType="String" />
		<result property="interest" column="interest" jdbcType="VARCHAR"
			javaType="String" />

	</resultMap>
	<insert id="INSERT_USER" parameterClass="USER_POJO">
         <![CDATA[
            INSERT INTO qth_user
                (
                 gmt_created,
                 gmt_modified,
                 creator,
                 modifier,
                 is_deleted,
                 login_id,
                 password,
                 name,
                 gender,
                 email,
                 phone_area,
                 phone_number,
                 mobile_phone,
                 company,
                 company_address,
                 role,
                 id_card_num,
                 busi_license,
                 user_level,
                 status
                 )
               VALUES
               (
				now(),
				now(),
	            'system',
	            'system',
	            'n',
				#loginId#,
				md5(#password#),
				#name#,
				#gender#,
				#email#,
				#phoneArea#,
				#phoneNumber#,
				#mobilePhone#,
				#company#,
				#companyAddress#,
				#role#,
				#idCardNum#,
				#busiLicense#,
				#userLevel#,
				#status#
	        )
        ]]>
		<selectKey resultClass="Integer" keyProperty="id">
             <![CDATA[ SELECT LAST_INSERT_ID() AS ID ]]>
		</selectKey>
	</insert>
	<update id="UPDATE_USER" parameterClass="USER_POJO"><![CDATA[
        update
                qth_user
        set
                gmt_modified=now() ]]>
		<isNotNull property="isDeleted" prepend=",">
			is_deleted=#isDeleted#</isNotNull>
		<isNotNull property="modifier" prepend=",">
			modifier=#modifier#
		</isNotNull>
		<isNotNull property="name" prepend=",">
			name=#name#</isNotNull>
		<isNotNull property="password" prepend=",">
			password=md5(#password#)</isNotNull>
		<isNotNull property="gender" prepend=",">
			gender=#gender#
		</isNotNull>
		<isNotNull property="email" prepend=",">
			email=#email#
		</isNotNull>
		<isNotNull property="phoneArea" prepend=",">
			phone_area=#phoneArea#</isNotNull>
		<isNotNull property="phoneNumber" prepend=",">
			phone_number=#phoneNumber#</isNotNull>
		<isNotNull property="mobilePhone" prepend=",">
			mobile_phone=#mobilePhone#</isNotNull>
		<isNotNull property="company" prepend=",">
			company=#company#
		</isNotNull>
		<isNotNull property="companyAddress" prepend=",">
			company_address=#companyAddress#</isNotNull>
		<isNotNull property="role" prepend=",">
			role=#role#</isNotNull>
		<isNotNull property="idCardNum" prepend=",">
			id_card_num=#idCardNum#</isNotNull>
		<isNotNull property="busiLicense" prepend=",">
			busi_license=#busiLicense#</isNotNull>
		<isNotNull property="userLevel" prepend=",">
			user_level=#userLevel#</isNotNull>
		<isNotNull property="status" prepend=",">
			status=#status#
		</isNotNull>
		where
		id = #id#
	</update>

	<select id="QUERY_USER_BYID" resultMap="USER_RESULT_MAP"
		parameterClass="java.lang.Long">
		 <![CDATA[
				select
				*
				from qth_user where  is_deleted='n' AND id=#id#]]>
	</select>
	<select id="QUERY_USER_BY_LOGINID" resultMap="USER_RESULT_MAP"
		parameterClass="java.lang.String">
		 <![CDATA[
				select
				*
				from qth_user where  is_deleted='n' AND login_id=#loginId#]]>
	</select>
	<select id="QUERY_USER_BY_MAP" resultMap="USER_RESULT_MAP"
		parameterClass="map">
		 <![CDATA[
				select
				*
				from qth_user u,qth_user_interest i where  u.is_deleted='n' and i.is_deleted='n']]>
		<isNotNull property="name" prepend="AND">
			u.name=#name#
		</isNotNull>
		<isNotNull property="password" prepend="AND">
			u.password=md5(#password#)
		</isNotNull>
		<isNotNull property="loginId" prepend="AND">
			u.login_id=#loginId#
		</isNotNull>
		<isNotNull property="company" prepend="AND">
			u.company like
			CONCAT('%',#company#, '%')
		</isNotNull>
		<isNotNull property="userLevel" prepend="AND">
			u.user_level=#userLevel#
		</isNotNull>
		<isNotNull property="status" prepend="AND">
			u.status=#status#
		</isNotNull>
		<isNotNull property="gender" prepend="AND">
			u.gender=#gender#
		</isNotNull>
		<isNotNull property="email" prepend="AND">
			u.email=#email#
		</isNotNull>
		<isNotNull property="phoneNumber" prepend="AND">
			u.phone_number=#phoneNumber#
		</isNotNull>
		<isNotNull property="phoneArea" prepend="AND">
			u.phone_area=#phoneArea#
		</isNotNull>
		<isNotNull property="mobilePhone" prepend="AND">
			u.mobile_phone=#mobilePhone#
		</isNotNull>
		<isNotNull property="role" prepend="AND">
			u.role=#role#
		</isNotNull>
		<isNotNull property="idCardNum" prepend="AND">
			u.id_card_num=#idCardNum#
		</isNotNull>
		<isNotNull property="busiLicense" prepend="AND">
			u.busi_license=#busiLicense#
		</isNotNull>
		<isNotNull property="saleInterests" prepend="AND">
			u.login_id=i.login_id and i.interest='sale' and i.value in
			<iterate property="saleInterests" open="(" close=")"
				conjunction=","> #saleInterests[]#</iterate>
		</isNotNull>
		<isNotNull property="buyInterests" prepend="AND">
			u.login_id=i.login_id and i.interest='buy' and i.value in
			<iterate property="buyInterests" open="(" close=")"
				conjunction=","> #buyInterests[]#</iterate>
		</isNotNull>
		<![CDATA[group by u.id ]]>
		<include refid="ALICRM_COMMON.ALI_PAGING" />
	</select>

	<insert id="INSERT_INTEREST" parameterClass="INTEREST_POJO">
         <![CDATA[
            INSERT INTO qth_user_interest
                (
                 gmt_created,
                 gmt_modified,
                 creator,
                 modifier,
                 is_deleted,
                 login_id,
                 interest,
                 value
                 )
               VALUES
               (
				now(),
				now(),
	            'system',
	            'system',
	            'n',
				#loginId#,
				#interest#,
				#value#
	        )
        ]]>
		<selectKey resultClass="Integer" keyProperty="id">
             <![CDATA[ SELECT LAST_INSERT_ID() AS ID ]]>
		</selectKey>
	</insert>

	<select id="GET_EXIST_INTEREST" resultMap="USER_INTEREST_RESULT_MAP"
		parameterClass="INTEREST_POJO">
		 <![CDATA[
				select
				*
				from qth_user_interest where  is_deleted='n'
				AND login_id=#loginId#
				and value=#value#
				and interest=#interest#]]>
	</select>
	<select id="SELECT_BUY_INST" resultMap="USER_INTEREST_RESULT_MAP"
		parameterClass="java.lang.String">
		 <![CDATA[
				select
				*
				from qth_user_interest where  is_deleted='n'
				AND login_id=#loginId#
				and interest='buy']]>
	</select>
	<select id="SELECT_SALE_INST" resultMap="USER_INTEREST_RESULT_MAP"
		parameterClass="java.lang.String">
		 <![CDATA[
				select
				*
				from qth_user_interest where  is_deleted='n'
				AND login_id=#loginId#
				and interest='sale']]>
	</select>

	<update id="DELETE_INTEREST_BY_IDS" parameterClass="map"><![CDATA[
        update
                qth_user_interest
        set
                gmt_modified=now(),
                is_deleted='y'
                ]]>
		where 1=0
		<isNotNull property="buyInterests" prepend="OR">
			<![CDATA[(login_id =#loginId#  and interest='buy' and value not IN]]>
			<iterate property="buyInterests" open="(" close=")"
				conjunction=","> #buyInterests[]#</iterate>
				<![CDATA[) ]]>
		</isNotNull>
		<isNotNull property="saleInterests" prepend="OR">
			<![CDATA[(login_id =#loginId#  and interest='sale' and value not IN]]>
			<iterate property="saleInterests" open="(" close=")"
				conjunction=","> #saleInterests[]#</iterate>
				<![CDATA[) ]]>
		</isNotNull>
	</update>
</sqlMap>


